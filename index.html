<!-- ... Keep your existing <head> and <style> exactly as they are ... -->

<script>
    // 1. UPDATE THIS TO YOUR ACTUAL HUGGING FACE URL
    const BACKEND_URL = 'https://bariqmalik-ibetube-backend.hf.space';

    async function fetchInfo() {
        const urlInput = document.getElementById('url').value;
        if(!urlInput) { alert("Please paste a URL!"); return; }

        const btn = document.getElementById('btn');
        const loader = document.getElementById('loader');
        const resDiv = document.getElementById('result');

        btn.disabled = true;
        loader.classList.remove('hidden');
        resDiv.classList.add('hidden');

        try {
            const response = await fetch(`${BACKEND_URL}/get_info`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: urlInput})
            });
            
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Using the correct keys from our Python backend
            document.getElementById('thumb').src = data.thumb;
            document.getElementById('title').innerText = data.title;
            
            const duration = data.duration || 0;
            const minutes = Math.floor(duration / 60);
            document.getElementById('durationBadge').innerText = `${minutes} min`;

            // This is the part that was causing the 'map' error
            // Now data.video and data.audio exist!
            document.getElementById('vList').innerHTML = (data.video || []).map(v => `
                <button onclick="startDownload('${urlInput}', '${v.id}', 'video')" class='liquid-btn w-full py-4 rounded-xl text-[11px] font-bold text-white flex justify-between px-5'>
                    <span>${v.res}</span>
                    <span class="text-indigo-400">MP4</span>
                </button>
            `).join('');

            document.getElementById('aList').innerHTML = (data.audio || []).map(a => `
                <button onclick="startDownload('${urlInput}', '${a.id}', 'mp3')" class='liquid-btn w-full py-4 rounded-xl text-[11px] font-bold text-white flex justify-between px-5'>
                    <span>${a.q}</span>
                    <span class="text-purple-400">MP3</span>
                </button>
            `).join('');

            resDiv.classList.remove('hidden');
        } catch(e) { 
            alert("Error: " + e.message); 
        } finally {
            loader.classList.add('hidden');
            btn.disabled = false;
        }
    }

    function startDownload(url, format, mode) {
        document.getElementById('processingOverlay').style.display = 'flex';
        // This builds a link like: https://backend.hf.space/download?url=...&fmt=...&mode=...
        const downloadUrl = `${BACKEND_URL}/download?url=${encodeURIComponent(url)}&fmt=${format}&mode=${mode}`;
        window.location.href = downloadUrl;
        
        // Hide overlay after a few seconds because browser handles the download
        setTimeout(() => {
            document.getElementById('processingOverlay').style.display = 'none';
        }, 5000);
    }
</script>
